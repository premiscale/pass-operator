version: 2.1


orbs:
  general: premiscale/general@1.0.2


executors:
  python-3-10:
    docker:
      - image: cimg/python:3.10.11

workflows:
  src:
    jobs:
      - general/python-pylint:
          name: pylint
          modules_path: src/
          context: nexus

      # develop

      - general/python-release-poetry:
          name: twine upload [python-develop]
          context: nexus
          repository: python-develop
          version: 0.0.<< pipeline.number >>
          pypirc-config: .pypirc
          requires:
            - pylint
          filters:
            branches:
              ignore:
                - master

      - general/docker-nexus:
          name: docker nexus [password-store-operator] [develop]
          image-name: password-store-operator
          context: nexus
          nexus-domain: $DOCKER_DEVELOP_DOMAIN
          args: >-
            --build-arg=PYTHON_PACKAGE_VERSION=0.0.<< pipeline.number >>
            --build-arg=PYTHON_USERNAME=$NEXUS_USERNAME
            --build-arg=PYTHON_PASSWORD=$NEXUS_PASSWORD
            --build-arg=PYTHON_REPOSITORY=python-develop
          tag: 0.0.<< pipeline.number >>
          requires:
            - twine upload [python-develop]
          filters:
            branches:
              ignore:
                - master

      # master

      - general/python-release-poetry:
          name: twine upload [python-master]
          context: nexus
          repository: python-master
          version: 0.0.<< pipeline.number >>
          pypirc-config: .pypirc
          requires:
            - pylint
          filters:
            branches:
              only:
                - master

      - general/docker-nexus:
          name: docker [password-operator-python] [master]
          image-name: password-store-operator
          context: nexus
          nexus-domain: $DOCKER_MASTER_DOMAIN
          args: >-
            --build-arg=PYTHON_PACKAGE_VERSION=0.0.<< pipeline.number >>
            --build-arg=PYTHON_USERNAME=$NEXUS_USERNAME
            --build-arg=PYTHON_PASSWORD=$NEXUS_PASSWORD
            --build-arg=PYTHON_REPOSITORY=python-master
          tag: 0.0.<< pipeline.number >>
          requires:
            - twine upload [python-master]
          filters:
            branches:
              only:
                - master