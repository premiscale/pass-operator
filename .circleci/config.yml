version: 2.1

setup: true


orbs:
  dynamic: bjd2385/dynamic-continuation@3.8.1
  general: premiscale/general@1.0.12
  slack: circleci/slack@4.12.5


workflows:
  pass-operator:
    jobs:
      - dynamic/continue:
          base-revision: master
          context: circleci

      - slack/on-hold:
          context: slack
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - request-approval:
          requires:
            - slack/on-hold
          type: approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/github-release:
          name: Create GitHub release from tag
          context: github
          requires:
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/helm-release-nexus:
          name: helm build and push [helm/operator]
          context: nexus
          path: helm/operator
          requires:
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/python-release-poetry:
          name: nexus pass-operator upload [python]
          context: nexus
          repository: python
          requires:
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/python-release-poetry:
          name: pypi pass-operator upload [pypi]
          context: pypi
          repository: pypi
          requires:
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/docker-nexus:
          name: docker [pass-operator] [tag]
          image-name: pass-operator
          context: nexus
          nexus-domain: $DOCKER_DOMAIN
          args: >-
            --build-arg=PYTHON_PACKAGE_VERSION=$CIRCLE_TAG
            --build-arg=PYTHON_USERNAME=$NEXUS_USERNAME
            --build-arg=PYTHON_PASSWORD=$NEXUS_PASSWORD
            --build-arg=PYTHON_REPOSITORY=python
          requires:
            - nexus pass-operator upload [python]
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/docker-hub:
          name: dockerhub [pass-operator] [tag]
          image-name: pass-operator
          context:
            - nexus
            - dockerhub
          # This installs the artifact from my private registry instead of the public one.
          args: >-
            --build-arg=PYTHON_PACKAGE_VERSION=0.0.<< pipeline.number >>
            --build-arg=PYTHON_USERNAME=$NEXUS_USERNAME
            --build-arg=PYTHON_PASSWORD=$NEXUS_PASSWORD
            --build-arg=PYTHON_REPOSITORY=python-develop
          requires:
            - nexus pass-operator upload [python]
            - request-approval
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/helm-release-nexus:
          name: helm [helm/operator] [tag]
          context: nexus
          repo: $HELM_REPOSITORY_URL
          # Uses https://mikefarah.gitbook.io/yq/operators/env-variable-operators#dynamically-update-a-path-from-an-environment-variable
          image-tag-path: .deployment.image.tag
          requires:
            - dockerhub [pass-operator] [tag]
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/

      - general/helm-upgrade:
          name: helm upgrade install [helm/operator] [tag]
          cluster: $CHELSEA_CLUSTER
          namespace: pass-operator
          repo: $HELM_REPOSITORY_URL
          additional-values: >-
            --set global.registry="$DOCKER_DOMAIN"
            --set deployment.pullSecrets[0]=nexus-docker-registry
            --set operator.interval="$OPERATOR_INTERVAL"
            --set operator.initial_delay="$OPERATOR_INITIAL_DELAY"
            --set operator.priority="$OPERATOR_PRIORITY"
            --set operator.ssh.createSecret="true"
            --set operator.pass.binary="$PASS_BINARY"
            --set operator.pass.directory="$PASS_DIRECTORY"
            --set operator.gpg.key_id="$PASS_GPG_KEY_ID"
            --set operator.git.url="$PASS_GIT_URL"
            --set operator.git.branch="$PASS_GIT_BRANCH"
            --set operator.ssh.value="$(printf "$PASS_SSH_PRIVATE_KEY" | base64)"
          requires:
            - helm [helm/operator] [tag]
          context:
            - password-store-operator
            - kubeconfig
            - nexus
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^v?[0-9]+\.[0-9]+\.[0-9]+$/
